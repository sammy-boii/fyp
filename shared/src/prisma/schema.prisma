generator client {
  provider = "prisma-client"
  output   = "../prisma/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Workflow {
  id       Int    @id @default(autoincrement())
  authorId String // cuid
  author   User   @relation(fields: [authorId], references: [id])

  name        String?
  description String?
  status      String  @default("inactive") // active, inactive, paused
  nodes       Json // React Flow nodes
  edges       Json // React Flow edges

  executions WorkflowExecution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkflowExecution {
  id         String   @id @default(cuid())
  workflowId Int
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  status String  @default("running") // running, completed, failed, cancelled
  error  String?

  nodeExecutions NodeExecution[]

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model NodeExecution {
  id          String            @id @default(cuid())
  executionId String
  execution   WorkflowExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  nodeId     String // React Flow node ID
  nodeType   String // GMAIL, GOOGLE_DRIVE, etc.
  actionId   String // send_email, read_email, etc.
  config     Json // Node configuration/parameters
  inputData  Json? // Data from previous nodes
  outputData Json? // Output data from this node
  error      String?

  status String @default("pending") // pending, running, completed, failed

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([executionId])
  @@index([nodeId])
}

model User {
  id       String  @id @default(cuid())
  name     String
  email    String  @unique
  password String
  avatar   String?

  otp          String?
  otpExpiresAt DateTime?

  workflows   Workflow[]
  credentials OAuthCredential[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OAuthCredential {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  provider String
  service  String?
  notes    String?

  accessToken           String
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scopes                String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // A user can only have one credential for a unique service from a unique provider
  @@unique([provider, service, userId])
}
